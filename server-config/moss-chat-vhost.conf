# VirtualHost configuration for moss-chat.managedkube.com
# This proxies to a TypeScript web server application

# HTTP - Redirect to HTTPS
<VirtualHost *:80>
  ServerName moss-chat.managedkube.com
  
  # Support Let's Encrypt domain renewal
  <IfModule mod_proxy.c>
    ProxyPass /.well-known !
  </IfModule>
  
  # Redirect all HTTP to HTTPS
  RewriteEngine On
  RewriteCond %{HTTPS} !=on
  RewriteCond %{REQUEST_URI} !^/\.well-known
  RewriteRule ^/(.*) https://%{SERVER_NAME}/$1 [R=301,L]
</VirtualHost>

# HTTPS - Proxy to TypeScript app
<VirtualHost *:443>
  ServerName moss-chat.managedkube.com
  
  SSLEngine on
  # TODO: Update these paths after generating SSL certificate
  # Run: sudo /opt/bitnami/bncert-tool to generate Let's Encrypt cert
  # Or manually specify your certificate paths:
  SSLCertificateFile "/opt/bitnami/apache2/conf/moss-chat.managedkube.com.crt"
  SSLCertificateKeyFile "/opt/bitnami/apache2/conf/moss-chat.managedkube.com.key"
  
  # Support Let's Encrypt domain renewal
  <IfModule mod_proxy.c>
    ProxyPass /.well-known !
  </IfModule>
  
  # Proxy settings for TypeScript/Node.js app
  ProxyPreserveHost On
  ProxyRequests Off
  
  # WebSocket support (if needed)
  RewriteEngine On
  RewriteCond %{HTTP:Upgrade} =websocket [NC]
  RewriteRule /(.*) ws://127.0.0.1:3000/$1 [P,L]
  
  # Proxy all requests to the TypeScript app
  ProxyPass / http://127.0.0.1:3000/
  ProxyPassReverse / http://127.0.0.1:3000/
  
  # Error handling
  ErrorDocument 503 "Service temporarily unavailable. The application may be starting up."
</VirtualHost>
